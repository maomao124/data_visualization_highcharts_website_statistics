<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>散点图</title>

    <script src="./js/highcharts.js"></script>
    <script src="./js/exporting.js"></script>
    <script src="./js/series-label.js"></script>
    <script src="./js/zh_cn.js"></script>
    <script src="./js/axios.js"></script>
    <script src="./js/highcharts-more.js"></script>

</head>

<style>
    #container {
        width: 95vw;
        height: 50vh;
    }

    #container2 {
        width: 95vw;
        height: 50vh;
    }

    #container3 {
        width: 95vw;
        height: 50vh;
    }
</style>
<body>

<div id="container"></div>

<br>
<div id="container2"></div>

<br>
<div id="container3"></div>

<script>
    Highcharts.setOptions({
        global: {
            useUTC: false
        }
    });

    function activeLastPointToolip(chart)
    {
        var points = chart.series[0].points;
        chart.tooltip.refresh(points[points.length - 1]);
    }

    var chart = Highcharts.chart('container', {
        chart: {
            type: 'spline',
            marginRight: 10,
            events: {
                load: function ()
                {
                    var series = this.series[0],
                        chart = this;
                    activeLastPointToolip(chart);
                    setInterval(function ()
                    {
                        //axios发起ajax请求
                        axios({
                            //请求的方式：
                            method: "get",
                            //请求的url:
                            url: "/statistics/qps",
                        }).then(response =>
                        {
                            let d
                            if (response.data.status === false)
                            {
                                var x, y = -1;
                                if (response.data.time !== undefined)
                                {
                                    x = response.data.time
                                }
                                else
                                {
                                    d = new Date()
                                    x = d.getTime();
                                }
                                series.addPoint([x, y], true, true);
                                activeLastPointToolip(chart);
                            }
                            else
                            {
                                var x, y = -1;
                                x = response.data.time
                                y = response.data.data;
                                console.log(y);
                                series.addPoint([x, y], true, true);
                                activeLastPointToolip(chart);
                            }


                        }).catch(error =>
                        {
                            console.log(error)
                            series.addPoint([new Date().getTime(), -1], true, true);
                            activeLastPointToolip(chart);
                        })

                    }, 1000);
                }
            }
        },
        title: {
            text: '网站当前QPS'
        },
        xAxis: {
            type: 'datetime',
            tickPixelInterval: 150
        },
        yAxis: {
            title: {
                text: "QPS"
            }
        },
        tooltip: {
            formatter: function ()
            {
                return '<b>' + this.series.name + '</b><br/>' +
                    Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                    Highcharts.numberFormat(this.y, 0);
            }
        },
        legend: {
            enabled: false
        },
        series: [{
            name: 'QPS',
            data: (function ()
            {
                var data = [], time = (new Date()).getTime(), i;
                for (i = -19; i <= 0; i += 1)
                {
                    data.push({
                        x: time + i * 1000,
                        y: 0
                    });
                }
                return data;
            }())
        }]
    });


    var chart2 = Highcharts.chart('container2', {
        chart: {
            type: 'gauge',
            plotBackgroundColor: null,
            plotBackgroundImage: null,
            plotBorderWidth: 0,
            plotShadow: false
        },
        title: {
            text: 'CPU使用率'
        },
        pane: {
            startAngle: -150,
            endAngle: 150,
            background: [{
                backgroundColor: {
                    linearGradient: {x1: 0, y1: 0, x2: 0, y2: 1},
                    stops: [
                        [0, '#FFF'],
                        [1, '#333']
                    ]
                },
                borderWidth: 0,
                outerRadius: '109%'
            }, {
                backgroundColor: {
                    linearGradient: {x1: 0, y1: 0, x2: 0, y2: 1},
                    stops: [
                        [0, '#333'],
                        [1, '#FFF']
                    ]
                },
                borderWidth: 1,
                outerRadius: '107%'
            }, {
                // default background
            }, {
                backgroundColor: '#DDD',
                borderWidth: 0,
                outerRadius: '105%',
                innerRadius: '103%'
            }]
        },
        // the value axis
        yAxis: {
            min: 0,
            max: 100,
            minorTickInterval: 'auto',
            minorTickWidth: 1,
            minorTickLength: 10,
            minorTickPosition: 'inside',
            minorTickColor: '#666',
            tickPixelInterval: 30,
            tickWidth: 2,
            tickPosition: 'inside',
            tickLength: 10,
            tickColor: '#666',
            labels: {
                step: 2,
                rotation: 'auto'
            },
            title: {
                text: '%'
            },
            plotBands: [{
                from: 0,
                to: 30,
                color: '#55BF3B' // green
            }, {
                from: 30,
                to: 70,
                color: '#DDDF0D' // yellow
            }, {
                from: 70,
                to: 100,
                color: '#DF5353' // red
            }]
        },
        series: [{
            name: 'cpu',
            data: [0],
            tooltip: {
                valueSuffix: ' %'
            }
        }]
    }, function (chart)
    {
        if (!chart.renderer.forExport)
        {
            setInterval(function ()
            {
                var point = chart.series[0].points[0], newVal;

                //axios发起ajax请求
                axios({
                    //请求的方式：
                    method: "get",
                    //请求的url:
                    url: "/statistics/cpu",

                }).then(response =>
                {
                    if (response.data.status === false)
                    {
                        point.update(0);
                    }
                    else
                    {
                        console.log("cpu使用率：" + response.data.data)
                        point.update(response.data.data);
                    }
                }).catch(error =>
                {
                    console.log(error)
                    point.update(0);
                })

            }, 3000);
        }
    });


    var chart3 = Highcharts.chart('container3', {
        chart: {
            type: 'area',
            marginRight: 10,
            events: {
                load: function ()
                {
                    var series = this.series,
                        chart = this;
                    setInterval(function ()
                    {
                        //axios发起ajax请求
                        axios({
                            //请求的方式：
                            method: "get",
                            //请求的url:
                            url: "/statistics/memory",
                        }).then(response =>
                        {
                            if (response.data.status === false)
                            {
                                series[0].addPoint([new Date().getTime(), 0], true, true);
                                series[1].addPoint([new Date().getTime(), 0], true, true);
                                series[2].addPoint([new Date().getTime(), 0], true, true);
                                activeLastPointToolip(chart);
                            }
                            else
                            {
                                console.log("内存使用：" + JSON.stringify(response.data.data))
                                series[0].addPoint([new Date().getTime(), response.data.data.use], true, true)
                                series[1].addPoint([new Date().getTime(), response.data.data.max], true, true)
                                series[2].addPoint([new Date().getTime(), response.data.data.total], true, true)
                                activeLastPointToolip(chart);
                            }
                        }).catch(error =>
                        {
                            series[0].addPoint([new Date().getTime(), 0], true, true);
                            series[1].addPoint([new Date().getTime(), 0], true, true);
                            series[2].addPoint([new Date().getTime(), 0], true, true);
                            activeLastPointToolip(chart);
                        })

                    }, 3000);
                }
            }
        },
        title: {
            text: '内存使用量'
        },
        xAxis: {
            type: 'datetime',
            tickPixelInterval: 150
        },
        yAxis: {
            title: {
                text: "使用量(MB)"
            }
        },
        tooltip: {
            formatter: function ()
            {
                return '<b>' + this.series.name + '</b><br/>' +
                    Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                    Highcharts.numberFormat(this.y, 2)+" MB";
            }
        },
        legend: {
            enabled: false
        },
        series: [{
            name: '当前已使用',
            data: (function ()
            {
                var data = [], time = (new Date()).getTime(), i;
                for (i = -19; i <= 0; i += 1)
                {
                    data.push({
                        x: time + i * 1000,
                        y: 0
                    });
                }
                return data;
            }())
        },
            {
                name: '当前已分配',
                data: (function ()
                {
                    var data = [], time = (new Date()).getTime(), i;
                    for (i = -19; i <= 0; i += 1)
                    {
                        data.push({
                            x: time + i * 1000,
                            y: 0
                        });
                    }
                    return data;
                }())
            }
            ,
            {
                name: '总内存',
                data: (function ()
                {
                    var data = [], time = (new Date()).getTime(), i;
                    for (i = -19; i <= 0; i += 1)
                    {
                        data.push({
                            x: time + i * 1000,
                            y: 0
                        });
                    }
                    return data;
                }())
            }]
    });

</script>

</body>
</html>
